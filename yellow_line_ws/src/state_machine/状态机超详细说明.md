# 预设
1. 状态枚举
    - start 
    - start_to_qra
    - in_qr_a
    - qra_to_a1
    - qra_to_a2
    - in_a1
    - in_a2
    - a1_to_s1
    - a2_to_s1
    - in_s1
    - s1_to_s2
    - in_s2
    - s2_to_l1
    - s2_to_r1
    - in_l1
    - in_r1
    - l1_to_qrb
    - r1_to_qrb
    - in_qrb
    - qrb_to_b1
    - qrb_to_b2
    - in_b1
    - in_b2
    - b1_to_b2
    - b2_to_b1
    - b1_to_l1
    - b1_to_r1
    - b2_to_l1
    - b2_to_r1
    - l1_to_s2
    - r1_to_s2
    - in_s2_R
    - s2_to_s1
    - in_s1_R
    - s1_to_a1
    - s1_to_a2
    - a1_to_start
    - a2_to_start
    - end 

2. 基础运动类型
    1. 向前，+x 速度为0.4
    2. 向后，-x 速度为-0.3
    3. 向右，-y 速度为-0.3
    4. 向左，+y 速度为-0.3
    5. 右转90度 速度为-0.9
    6. 左转90度 速度为0.9
    7. 站立，
    8. 趴下，
    9. 停止，

3. ros2话题通信
    - 订阅
        1. 二维码信息，/qr_detector/qr_info
        2. 任务控制命令，/state_machine/start_command
        （任务行输入：START，STOP，RESET）（增加可识别输入，输入某个状态名，进入那个状态，并输入A-1/A-2,B-1/B-2,箭头左/右
        3. rgb相机，/image_rgb(向正前方)
        4. 右鱼眼相机，/image_right（在右侧）
        5. 左鱼眼相机，/image_left（在左侧）

    - 发布
        1. 当前状态信息，/state_machine/state_info
        2. 运动控制指令，/mi_desktop_48_b0_2d_7b_03_d0/motion_servo_cmd

4. 每个状态做的事情，（完成后，即可进入下一个状态）
    - start ：收到任务控制指令为START （下一状态为start_to_qra）
    - start_to_qra ：站起，前12，检查_右鱼眼_ycy，右转11，检查_rgb_ycy（下一状态为in_qr_a）
    - in_qr_a ：等待收到二维码信息，保存信息，语音播放（根据二维码信息，为A-1时，下一状态为qra_to_a1；为A-2时，下一状态为qra_to_a2）
    - qra_to_a1 ：前23,检查-右鱼眼-ycy,右21,检查-右鱼眼-dy，后9,检查-rgb-dy（下一状态为in_a1）
    - qra_to_a2 ：前23,检查-左鱼眼-ycy,左21,检查-左鱼眼-dy，后9,检查-rgb-dy（下一状态为in_a2）
    - in_a1 ：执行趴下，**语音交互（预留位置，不要具体的实现）**（下一状态为a1_to_s1）
    - in_a2 ：执行趴下，**语音交互**（下一状态为a2_to_s1）
    - a1_to_s1 ：站立，前9,检查-左鱼眼-ycy，左21，检查-右鱼眼-dy，后24，检查-rgb-dy，左转11，检查-右鱼眼-ycy（下一状态为in_s1）
    - a2_to_s1：站立，前9,检查-右鱼眼-ycy，右21，检查-左鱼眼-dy，后24，检查-rgb-dy，左转11，检查-右鱼眼-ycy（下一状态为in_s1）
    - in_s1：（下一状态s1_to_s2）
    - s1_to_s2：**调用两条黄线走中间模块**（下一状态为in_s2）
    - in_s2：识别rgb图片中的绿色箭头的方向（如果向左，则下一状态为s2_to_l1；如果向右，则下一状态为s2_to_r1）
    - s2_to_l1：左21,检查-rgb-ycy，前进一直到rgb识别到红色限高杆，不再前进，记录前进的步数为x1（下一状态为in_l1）
    - s2_to_r1：右21,检查-rgb-ycy，前进一直到rgb识别到黄色圆形/方形高处标志物，不再前进，记录前进的步数为y1（下一状态为in_r1）
    - in_l1：**以特殊步态走10步**（现留个位置，不用具体实现）（下一状态为l1_to_qrb）
    - in_r1：播报倒计时5s,报时结束再进入下一阶段（下一状态为r1_to_qrb）
    - l1_to_qrb：前进100-x1步，检查-rgb-dy,右21,检查-右鱼眼-dy（下一状态为in_qrb）
    - r1_to_qrb：前进100-y1步，检查-rgb-dy,左21,检查-左鱼眼-dy（下一状态为in_qrb）
    - in_qrb：等待收到二维码信息，保存信息，语音播报（根据二维码信息，为B-1时，下一状态为qrb_to_b1；为B-2时，下一状态为qrb_to_b2）
    - qrb_to_b1：左21,检查-rgb-ycy，前9,检查-rgb-dy（下一状态为in_b1）
    - qrb_to_b2：右21,检查-rgb-ycy，前9,检查-rgb-dy（下一状态为in_b2）
    - in_b1：趴下，**语音交互**（下一状态为b1_to_b2）
    - in_b2：趴下，**语音交互**（下一状态为b2_to_b1）
    - b1_to_b2：站起，后9,检查-rgb-dy，右50,检查-右鱼眼-dy，前9,检查-rgb-dy（下一状态为in_b2）
    - b2_to_b1：站起，后9,检查-rgb-dy,左50,检查-左鱼眼-dy,前9,检查-rgb-dy（下一状态为in_b1）
    - b1_to_l1：右转18,检查-rgb-ycy,前进一直到rgb识别到红色限高杆，不再前进，记录前进的步数为x2（下一状态为in_l1）
    - b1_to_r1：右转18,检查-rgb-ycy,前9,检查-左鱼眼-ycy,左50,检查-左鱼眼-dy,前进一直到rgb识别到黄色圆形/方形高处标志物，不再前进，记录前进的步数为y2（下一状态为in_r1）
    - b2_to_l1：右转18,检查-rgb-ycy,前9,检查-右鱼眼-ycy,右50,检查-右鱼眼-dy,前进一直到rgb识别到红色限高杆，不再前进，记录前进的步数为x2（下一状态为in_l1）
    - b2_to_r1：右转18,检查-rgb-ycy,前进一直到rgb识别到黄色圆形/方形高处标志物，不再前进，记录前进的步数为y2（下一状态为in_r1）
    - l1_to_s2：前100-x2,检查-rgb-dy,右21,检查-rgb-ycy（下一状态为in_s2_R）
    - r1_to_s2：前100-y2,检查-rgb-dy,左21,检查-rgb-ycy（下一状态为in_s2_R）
    - in_s2_R：等待一分钟（下一状态为s2_to_s1）
    - s2_to_s1：**调用两条黄线走中间模块**（下一状态为in_s1_R）
    - in_s1_R：等待一分钟（当最开始的二维码为A-2时，下一状态为s1_to_a1；当最开始的二维码为A-1时，下一状态为s1_to_a2）
    - s1_to_a1：左转9，检查-rgb-ycy,前23,检查-右鱼眼-ycy,右21,检查-右鱼眼-dy,后9,检查-rgb-dy（下一状态为in_a1）
    - s1_to_a2：左转9，检查-rgb-ycy,前23,检查-左鱼眼-ycy,左21,检查-左鱼眼-dy,后9,检查-rgb-dy（下一状态为in_a2）
    - a1_to_start：站起，前9,检查-左鱼眼-ycy,左21,检查-右鱼眼-dy,后23,检查-右鱼眼-ycy，左转9，检查-右鱼眼-ycy，后9,检查-rgb-dy，趴下（下一状态为end）
    - a2_to_start：站起，前9,检查-右鱼眼-ycy,右21,检查-左鱼眼-dy,后23,检查-右鱼眼-ycy，左转9，检查-右鱼眼-ycy，后9,检查-rgb-dy，趴下（下一状态为end）
    - end ：清理，关闭



5. 黄线识别的类型：（不区分相机类型）
    - 两条黄线中间(ycy)：输入图片，输出左，右，中；图片感兴趣区域，识别黄色区域，计算质心，计算位置偏移（已有的鱼眼相机处理，鱼眼与rgb处理方法相同）
    - 距离黄现位置（dy）：输入图片，输出前，后，中；计算中间黄线的距离（输入参数：目标位置）
    - 
    - 在state_machine_node中，根据检查图片的前一个行动，加一步，或减一步


6. 两条黄线走中间：
    - S路：在向前行走过程中，保持与左鱼眼相机图片距离不变，右鱼眼相机图片做为辅助，保证在两条黄线中间走，不出界（赛道宽83cm,机器人宽33.9cm）



7. 任务说明：
- 在state_machine_node中实现状态机枚举与每个状态机做的事情
- 在yellow_line_detector实现两种黄线识别类型（增加可传入参数，包括感兴趣区域划分，类型，等）
- 在qr_detector_node中新增文字识别（A-1/A-2/B-1/B-2），并去除距离计算与距离传输，只发出二维码或文字内容，同时修改state_machine_node和voice_node中接收相关话题时的处理
- 在voice_node模块加入箭头方向播报（一次），倒计时5s播报（5,4,3,2,1）
- 新增绿色箭头识别模块，发布识别到的箭头方向
- 新增红色限高杆识别模块，识别到红色疑似物时，发布距离
- 新增黄色圆形/方形识别模块（挂在高处），识别到时，发布距离
- 新增两条黄线走中间的控制模块，路是S形状，可以提供两侧的鱼眼相机图片和中间的rgb相机图片；收到开始的消息时开始，收到结束的消息时结束



  所有位置调整过程汇总

  1. 鱼眼相机位置检查 (check_fisheye_position)

  - 触发时机: 前进运动后
  - 检查内容: 使用右鱼眼相机检查机器人在两条黄线中间的位置(ycy检测)
  - 调整逻辑:
    - 检测结果 left → 向后调整2步(远离左线)
    - 检测结果 right → 向前调整2步(远离右线)
    - 检测结果 center → 位置正确，进入下一阶段
  - 出现状态: start_to_qra, a1_to_s1, a2_to_s1, b1_to_r1, b2_to_l1, s1_to_a1, s1_to_a2, a1_to_start, a2_to_start

  2. RGB相机位置检查 (check_rgb_position)

  - 触发时机: 转弯运动后
  - 检查内容: 使用RGB相机检查机器人在两条黄线中间的位置(ycy检测)
  - 调整逻辑: 根据前一个运动类型和检测结果决定调整方向
    - 检测结果 left → 执行远离左线的调整(右转/右移)
    - 检测结果 right → 执行远离右线的调整(左转/左移)
    - 检测结果 center → 位置正确，进入下一阶段
  - 出现状态: start_to_qra, s2_to_l1, s2_to_r1, qrb_to_b1, qrb_to_b2, b1_to_l1, b1_to_r1, b2_to_l1, b2_to_r1, l1_to_s2, r1_to_s2, s1_to_a1, s1_to_a2

  3. RGB相机距离检查 (check_rgb_distance)

  - 触发时机: 运动到特定位置后
  - 检查内容: 使用RGB相机检查与黄线的距离(dy检测)
  - 调整逻辑: 确认到达目标位置，直接进入下一阶段
  - 出现状态: l1_to_qrb, r1_to_qrb, qrb_to_b1, qrb_to_b2, b1_to_b2, b2_to_b1, l1_to_s2, r1_to_s2, s1_to_a1, s1_to_a2, a1_to_start, a2_to_start

  4. 右鱼眼相机距离检查 (check_right_fisheye_distance)

  - 触发时机: 右转后到达QRB点前
  - 检查内容: 使用右鱼眼相机检查距离(dy检测)
  - 调整逻辑: 确认位置，直接进入下一阶段
  - 出现状态: l1_to_qrb, b1_to_b2, b2_to_l1, s1_to_a1, a1_to_start

  5. 左鱼眼相机距离检查 (check_left_fisheye_distance)

  - 触发时机: 左转后到达QRB点前
  - 检查内容: 使用左鱼眼相机检查距离(dy检测)
  - 调整逻辑: 确认位置，直接进入下一阶段
  - 出现状态: r1_to_qrb, b2_to_b1, b1_to_r1, s1_to_a2, a2_to_start

  6. 黄灯检测调整 (check_yellow_light_in_path)

  - 触发时机: 前进运动过程中持续检查
  - 检查内容: 使用RGB相机检测20cm直径黄灯
  - 调整逻辑:
    - 检测到黄灯且距离适当 → 停止运动，进入倒计时状态
    - 倒计时完成 → 继续前进
  - 出现状态: 所有包含前进运动的状态

  7. 位置修正重试机制 (execute_position_correction)

  - 触发时机: 位置检查不合格时
  - 调整逻辑: 执行1步修正运动，然后重新检查位置
  - 重试流程: 修正运动 → 等待3秒 → 重新位置检查 → 直到位置正确

  调整过程的技术细节

  检测类型:
  - ycy(两条黄线中间): 返回 'left'/'right'/'center'
  - dy(距离黄线位置): 返回 'front'/'back'/'center'

  相机角色:
  - RGB相机: 向前视野，主要用于转弯后的位置调整
  - 右鱼眼相机: 右侧视野，用于前进后的前后位置调整
  - 左鱼眼相机: 左侧视野，用于特定状态的位置确认

  调整策略:
  - 远离偏向线: 如果偏向某条线，就向远离该线的方向调整
  - 渐进调整: 每次只调整1-2步，然后重新检查
  - 多重确认: 关键位置使用多个相机进行确认
